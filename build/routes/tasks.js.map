{"version":3,"file":"tasks.js","names":["router","Router","get","req","res","LIMIT","query","page","userId","combined","start","end","readPermission","offset","readPermissionTypes","findIndex","status","json","succes","err","Task","findByQueriesTasks","tasks","goalIds","Array","from","Set","map","task","goal","taskIds","_id","Goal","findByGoalIds","goals","Compliment","findByTaskIds","taskIdAndComplimentsMap","response","find","toString","title","goalData","author","doneAt","createdAt","updatedAt","compliments","send","ids","params","split","result","post","create","body","set","name","message","patch","patchByTaskId","taskid","deleteByTaskId","sendStatus"],"sources":["../../src/routes/tasks.js"],"sourcesContent":["import {Router} from \"express\";\nimport {Task} from \"../models/task\";\nimport {Compliment} from \"../models/compliment\";\nimport {Goal} from \"../models/goal\";\nimport compliments from \"../../build/routes/compliments\";\nimport {readPermissionTypes} from \"../utils/types.js\";\n\nconst router = Router();\n\nrouter.get(\"/\", async (req, res) => {\n\tconst LIMIT = 20;\n\tconst {page, userId, combined, start, end, readPermission} = req.query;\n\tconst offset = page ? (page - 1) * LIMIT : null;\n\n\tif (readPermissionTypes.findIndex(readPermission) === -1) {\n\t\treturn res\n\t\t\t.status(400)\n\t\t\t.json({succes: false, err: `${readPermission} not matched`});\n\t}\n\n\ttry {\n\t\tconst tasks = await Task.findByQueriesTasks(\n\t\t\t{readPermission, userId, start, end},\n\t\t\tLIMIT,\n\t\t\toffset\n\t\t);\n\t\tif (!tasks) {\n\t\t\treturn res\n\t\t\t\t.status(404)\n\t\t\t\t.json({succes: false, err: `${readPermission} tasks not found!`});\n\t\t}\n\t\tif (combined !== \"true\") {\n\t\t\tres.json({tasks});\n\t\t\treturn;\n\t\t}\n\n\t\tconst goalIds = Array.from(new Set(tasks.map((task) => task.goal)));\n\t\tconst taskIds = tasks.map((task) => task._id);\n\n\t\t// 두개 병렬로 진행하도록?\n\t\tconst goals = await Goal.findByGoalIds(goalIds);\n\t\tconst taskIdAndComplimentsMap = await Compliment.findByTaskIds(taskIds);\n\n\t\t// 둘다끝나면 조합시키기\n\t\tconst response = tasks.map((task) => {\n\t\t\tconst goal =\n\t\t\t\tgoals.find((goal) => goal._id.toString() === task.goal) || null;\n\n\t\t\treturn {\n\t\t\t\t_id: task._id,\n\t\t\t\ttitle: task.title,\n\t\t\t\tgoal: task.goal,\n\t\t\t\tgoalData: goal,\n\t\t\t\tauthor: task.author,\n\t\t\t\treadPermission: task.readPermission,\n\t\t\t\tdoneAt: task.doneAt,\n\t\t\t\tcreatedAt: task.createdAt,\n\t\t\t\tupdatedAt: task.updatedAt,\n\t\t\t\tcompliments: taskIdAndComplimentsMap[task._id],\n\t\t\t};\n\t\t});\n\n\t\tres.json({tasks: response});\n\t} catch (err) {\n\t\tres.status(500).send(err);\n\t}\n});\n\nrouter.get(\"/:taskIds/compliments\", async (req, res) => {\n\ttry {\n\t\tconst ids = req.params.taskIds.split(\",\");\n\t\tconst result = await Compliment.findByTaskIds(ids);\n\t\tif (!result) {\n\t\t\treturn res.status(404).json({succes: false, err: \"User not found\"});\n\t\t}\n\t\tres.json(result);\n\t} catch (err) {\n\t\tres.status(500).send(err);\n\t}\n});\n\nrouter.post(\"/\", async (req, res) => {\n\ttry {\n\t\tconst result = await Task.create(req.body);\n\t\tres.set({\n\t\t\t\"Content-Location\": `tasks/${result._id}`,\n\t\t});\n\t\treturn res.json({\n\t\t\ttask: {result},\n\t\t});\n\t} catch (err) {\n\t\tif (err.name === \"ValidationError\") {\n\t\t\treturn res.status(400).json({succes: false, message: err.message});\n\t\t}\n\t\tres.status(500).send(err);\n\t}\n});\n\nrouter.patch(\"/:taskid\", async (req, res) => {\n\ttry {\n\t\tconst result = await Task.patchByTaskId(req.params.taskid, req.body);\n\t\tif (!result) {\n\t\t\treturn res.status(404).json({succes: false, message: \"task not found!\"});\n\t\t}\n\t\treturn res.json(result);\n\t} catch (err) {\n\t\tif (err.name === \"CastError\")\n\t\t\treturn res\n\t\t\t\t.status(400)\n\t\t\t\t.json({succes: false, message: \"taskId not valid for id type\"});\n\t\treturn res.status(500).json(err);\n\t}\n});\n\nrouter.delete(\"/:taskid\", async (req, res) => {\n\ttry {\n\t\tconst result = await Task.deleteByTaskId(req.params.taskid);\n\t\tif (!result) {\n\t\t\treturn res.status(404).json({succes: false, message: \"task not found!\"});\n\t\t}\n\t\treturn res.sendStatus(200);\n\t} catch (err) {\n\t\treturn res.status(500).json(err);\n\t}\n});\n\nexport default router;\n"],"mappings":"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"}